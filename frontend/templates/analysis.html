{% extends "base.html" %}

{% block title %}Analysis Results - Guardian LLM{% endblock %}

{% block description %}View detailed ethical risk analysis results for your AI research paper with comprehensive recommendations and insights.{% endblock %}

{% block body_class %}analysis-page{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
        Analysis Results
    </li>
{% endblock %}

{% block page_css %}
    <style>
        /* Analysis Page Specific Styles */
        .analysis-page {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .analysis-header {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .analysis-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .analysis-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .meta-item {
            text-align: center;
            padding: var(--space-4);
            background: var(--light-color);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .meta-label {
            font-size: var(--font-size-sm);
            color: var(--muted-color);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-2);
        }
        
        .meta-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-color);
        }
        
        .overall-score {
            text-align: center;
            margin: var(--space-8) 0;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-4);
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: white;
            position: relative;
            background: conic-gradient(from 0deg, var(--success-color) 0%, var(--warning-color) 50%, var(--danger-color) 100%);
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 50%;
            background: white;
        }
        
        .score-circle .score-text {
            position: relative;
            z-index: 1;
            color: var(--dark-color);
        }
        
        .score-label {
            font-size: var(--font-size-lg);
            color: var(--muted-color);
            font-weight: var(--font-weight-medium);
        }
        
        .risk-level-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-3);
        }
        
        .risk-level-badge.low {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .risk-level-badge.medium {
            background: rgba(255, 193, 7, 0.1);
            color: #e67e22;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .risk-level-badge.high {
            background: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
            border: 1px solid rgba(253, 126, 20, 0.3);
        }
        
        .risk-level-badge.critical {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .analysis-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--space-6);
        }
        
        .btn {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            font-weight: var(--font-weight-semibold);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            transition: all var(--transition-normal);
            border: 2px solid transparent;
            cursor: pointer;
            font-size: var(--font-size-base);
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
        }
        
        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }
        
        .risk-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        .risk-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .risk-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .risk-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .risk-card.low::before { background: var(--success-color); }
        .risk-card.medium::before { background: var(--warning-color); }
        .risk-card.high::before { background: #fd7e14; }
        .risk-card.critical::before { background: var(--danger-color); }
        
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-5);
        }
        
        .risk-category-info {
            flex: 1;
        }
        
        .risk-category-name {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-color);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .risk-icon {
            font-size: var(--font-size-2xl);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            background: var(--light-color);
        }
        
        .risk-icon.low { background: rgba(40, 167, 69, 0.1); color: var(--success-color); }
        .risk-icon.medium { background: rgba(255, 193, 7, 0.1); color: #e67e22; }
        .risk-icon.high { background: rgba(253, 126, 20, 0.1); color: #fd7e14; }
        .risk-icon.critical { background: rgba(220, 53, 69, 0.1); color: var(--danger-color); }
        
        .risk-score-display {
            text-align: right;
        }
        
        .risk-score-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-1);
        }
        
        .risk-score-number.low { color: var(--success-color); }
        .risk-score-number.medium { color: #e67e22; }
        .risk-score-number.high { color: #fd7e14; }
        .risk-score-number.critical { color: var(--danger-color); }
        
        .confidence-score {
            font-size: var(--font-size-sm);
            color: var(--muted-color);
        }
        
        .risk-explanation {
            color: var(--muted-color);
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--space-5);
            font-size: var(--font-size-base);
        }
        
        .evidence-section {
            margin-bottom: var(--space-5);
        }
        
        .section-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--dark-color);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .evidence-list {
            list-style: none;
            padding: 0;
        }
        
        .evidence-item {
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
            padding-left: var(--space-5);
            font-size: var(--font-size-sm);
            color: var(--muted-color);
            line-height: var(--line-height-relaxed);
        }
        
        .evidence-item:last-child {
            border-bottom: none;
        }
        
        .evidence-item::before {
            content: '•';
            position: absolute;
            left: var(--space-3);
            color: var(--primary-color);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
        }
        
        .recommendations-section {
            background: var(--light-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border: 1px solid var(--border-color);
        }
        
        .recommendation-item {
            padding: var(--space-2) 0;
            padding-left: var(--space-5);
            position: relative;
            font-size: var(--font-size-sm);
            line-height: var(--line-height-relaxed);
            color: var(--dark-color);
        }
        
        .recommendation-item::before {
            content: '→';
            position: absolute;
            left: var(--space-3);
            color: var(--info-color);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
        }
        
        .summary-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-8);
        }
        
        .summary-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }
        
        .summary-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-color);
            margin-bottom: var(--space-3);
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-5);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            text-align: center;
            padding: var(--space-5);
            background: var(--light-color);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-icon {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-3);
            color: var(--primary-color);
        }
        
        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--dark-color);
            margin-bottom: var(--space-1);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--muted-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: var(--font-weight-medium);
        }
        
        .key-insights {
            margin-top: var(--space-6);
        }
        
        .insight-item {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow-sm);
        }
        
        .insight-title {
            font-weight: var(--font-weight-semibold);
            color: var(--dark-color);
            margin-bottom: var(--space-2);
        }
        
        .insight-text {
            color: var(--muted-color);
            line-height: var(--line-height-relaxed);
        }
        
        .priority-alerts {
            margin-bottom: var(--space-8);
        }
        
        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            border: 1px solid;
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
        }
        
        .alert-critical {
            background: rgba(220, 53, 69, 0.05);
            border-color: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.05);
            border-color: rgba(255, 193, 7, 0.2);
            color: #856404;
        }
        
        .alert-info {
            background: rgba(23, 162, 184, 0.05);
            border-color: rgba(23, 162, 184, 0.2);
            color: #0c5460;
        }
        
        .alert-icon {
            font-size: var(--font-size-xl);
            margin-top: var(--space-1);
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }
        
        .timeline-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-8);
        }
        
        .timeline {
            position: relative;
            padding-left: var(--space-8);
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: var(--space-4);
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-6);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: calc(-1 * var(--space-8) + var(--space-3));
            top: var(--space-1);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .timeline-time {
            font-size: var(--font-size-sm);
            color: var(--muted-color);
            font-weight: var(--font-weight-medium);
        }
        
        .timeline-title {
            font-weight: var(--font-weight-semibold);
            color: var(--dark-color);
            margin: var(--space-1) 0 var(--space-2);
        }
        
        .timeline-description {
            color: var(--muted-color);
            line-height: var(--line-height-relaxed);
        }
        
        .export-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }
        
        .export-option {
            padding: var(--space-4);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
            color: var(--dark-color);
        }
        
        .export-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-2px);
        }
        
        .export-icon {
            font-size: var(--font-size-2xl);
            color: var(--primary-color);
            margin-bottom: var(--space-2);
        }
        
        .export-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
        }
        
        .export-description {
            font-size: var(--font-size-sm);
            color: var(--muted-color);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .analysis-meta {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-4);
            }
            
            .risk-categories {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }
            
            .risk-header {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .risk-score-display {
                text-align: left;
            }
            
            .analysis-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-3);
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print Styles */
        @media print {
            .analysis-actions,
            .export-section {
                display: none;
            }
            
            .risk-card {
                break-inside: avoid;
                margin-bottom: var(--space-4);
            }
            
            .summary-section {
                break-inside: avoid;
            }
        }
        
        /* Loading States */
        .loading-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .loading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .loading-title {
            height: 24px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            width: 200px;
        }
        
        .loading-score {
            height: 32px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            width: 80px;
        }
        
        .loading-content {
            height: 60px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-3);
        }
        
        .loading-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .loading-item {
            height: 16px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
        }
        
        .loading-item:nth-child(1) { width: 90%; }
        .loading-item:nth-child(2) { width: 80%; }
        .loading-item:nth-child(3) { width: 85%; }
    </style>
{% endblock %}

{% block main %}
    <div class="container">
        <!-- Priority Alerts -->
        <div class="priority-alerts" id="priorityAlerts">
            <!-- Alerts will be populated by JavaScript -->
        </div>

        <!-- Analysis Header -->
        <div class="analysis-header" id="analysisHeader">
            <!-- Header content will be populated by JavaScript -->
        </div>

        <!-- Analysis Summary -->
        <div class="summary-section" id="analysisSummary">
            <!-- Summary content will be populated by JavaScript -->
        </div>

        <!-- Risk Categories -->
        <div class="risk-categories" id="riskCategories">
            <!-- Risk cards will be populated by JavaScript -->
        </div>

        <!-- Analysis Timeline -->
        <div class="timeline-section" id="analysisTimeline" style="display: none;">
            <h2 class="summary-title">
                <i class="fas fa-history"></i>
                Analysis Timeline
            </h2>
            <div class="timeline" id="timelineContent">
                <!-- Timeline items will be populated by JavaScript -->
            </div>
        </div>

        <!-- Export & Actions -->
        <div class="export-section">
            <h2 class="summary-title">
                <i class="fas fa-download"></i>
                Export & Share Results
            </h2>
            <p style="color: var(--muted-color); margin-bottom: var(--space-6);">
                Download your analysis results in various formats or share with your team.
            </p>
            
            <div class="export-options">
                <div class="export-option" onclick="exportAnalysis('pdf')">
                    <div class="export-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="export-title">PDF Report</div>
                    <div class="export-description">Comprehensive analysis report</div>
                </div>
                
                <div class="export-option" onclick="exportAnalysis('excel')">
                    <div class="export-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <div class="export-title">Excel Data</div>
                    <div class="export-description">Structured data for analysis</div>
                </div>
                
                <div class="export-option" onclick="exportAnalysis('json')">
                    <div class="export-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="export-title">JSON Data</div>
                    <div class="export-description">Raw analysis data</div>
                </div>
                
                <div class="export-option" onclick="shareAnalysis()">
                    <div class="export-icon">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <div class="export-title">Share Link</div>
                    <div class="export-description">Generate shareable link</div>
                </div>
            </div>
            
            <div class="analysis-actions" style="margin-top: var(--space-6);">
                <button class="btn btn-primary" onclick="analyzeAnotherPaper()">
                    <i class="fas fa-plus"></i>
                    Analyze Another Paper
                </button>
                
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline">
                    <i class="fas fa-chart-line"></i>
                    View Dashboard
                </a>
                
                <button class="btn btn-outline" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Print Results
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block page_js %}
    <script>
        // Analysis data (populated from backend)
        let analysisData = null;
        let paperId = "{{ paper_id if paper_id else '' }}";
        
        // Initialize analysis page
        document.addEventListener('DOMContentLoaded', function() {
            if (paperId) {
                loadAnalysisData(paperId);
            } else {
                // Check for data in URL or local storage
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');
                
                if (dataParam) {
                    try {
                        analysisData = JSON.parse(decodeURIComponent(dataParam));
                        displayAnalysis(analysisData);
                    } catch (error) {
                        showError('Invalid analysis data');
                    }
                } else {
                    showError('No analysis data found');
                }
            }
            
            setupAnalysisInteractions();
        });
        
        // Load analysis data from API
        async function loadAnalysisData(id) {
            try {
                showGlobalLoading('Loading analysis results...');
                
                const response = await GuardianLLM.api.get(`/paper/${id}`);
                analysisData = response;
                
                hideGlobalLoading();
                displayAnalysis(analysisData);
                
            } catch (error) {
                hideGlobalLoading();
                showError('Failed to load analysis data: ' + error.message);
            }
        }
        
        // Display analysis results
        function displayAnalysis(data) {
            if (!data) {
                showError('No analysis data available');
                return;
            }
            
            // Display priority alerts
            displayPriorityAlerts(data);
            
            // Display header
            displayAnalysisHeader(data);
            
            // Display summary
            displayAnalysisSummary(data);
            
            // Display risk categories
            displayRiskCategories(data.risk_assessments || []);
            
            // Display timeline if available
            if (data.analysis_timeline) {
                displayAnalysisTimeline(data.analysis_timeline);
            }
            
            // Update page title
            document.title = `Analysis: ${data.title} - Guardian LLM`;
        }
        
        // Display priority alerts
        function displayPriorityAlerts(data) {
            const container = document.getElementById('priorityAlerts');
            const alerts = [];
            
            // Check for critical risks
            const criticalRisks = (data.risk_assessments || []).filter(r => r.level === 'critical');
            if (criticalRisks.length > 0) {
                alerts.push({
                    type: 'critical',
                    icon: 'exclamation-triangle',
                    title: `${criticalRisks.length} Critical Risk${criticalRisks.length > 1 ? 's' : ''} Detected`,
                    message: `Immediate attention required for: ${criticalRisks.map(r => formatCategoryName(r.category)).join(', ')}`
                });
            }
            
            // Check for high risks
            const highRisks = (data.risk_assessments || []).filter(r => r.level === 'high');
            if (highRisks.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'exclamation-circle',
                    title: `${highRisks.length} High Risk${highRisks.length > 1 ? 's' : ''} Found`,
                    message: `Review recommended for: ${highRisks.map(r => formatCategoryName(r.category)).join(', ')}`
                });
            }
            
            // Check overall score
            if (data.overall_risk_score >= 7.5) {
                alerts.push({
                    type: 'critical',
                    icon: 'shield-alt',
                    title: 'High Overall Risk Score',
                    message: `Overall score of ${data.overall_risk_score}/10 requires comprehensive review and mitigation strategies.`
                });
            }
            
            // Success message for low risk
            if (data.overall_risk_score < 2.5) {
                alerts.push({
                    type: 'info',
                    icon: 'check-circle',
                    title: 'Low Risk Assessment',
                    message: 'This paper shows minimal ethical risks. Continue with standard review processes.'
                });
            }
            
            // Render alerts
            if (alerts.length > 0) {
                container.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        <div class="alert-icon">
                            <i class="fas fa-${alert.icon}"></i>
                        </div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div>${alert.message}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.style.display = 'none';
            }
        }
        
        // Display analysis header
        function displayAnalysisHeader(data) {
            const container = document.getElementById('analysisHeader');
            const overallLevel = getRiskLevel(data.overall_risk_score);
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: var(--space-6);">
                    <h1 style="font-size: var(--font-size-4xl); font-weight: var(--font-weight-bold); margin-bottom: var(--space-3); color: var(--dark-color);">
                        Analysis Results
                    </h1>
                    <div style="font-size: var(--font-size-xl); color: var(--muted-color); margin-bottom: var(--space-4);">
                        ${GuardianLLM.utils.escapeHtml(data.title)}
                    </div>
                    ${data.authors && data.authors.length > 0 ? `
                        <div style="font-size: var(--font-size-base); color: var(--muted-color);">
                            Authors: ${data.authors.join(', ')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="analysis-meta">
                    <div class="meta-item">
                        <div class="meta-label">Paper ID</div>
                        <div class="meta-value" style="font-size: var(--font-size-base); font-family: var(--font-mono);">
                            ${data.paper_id}
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Analysis Date</div>
                        <div class="meta-value" style="font-size: var(--font-size-base);">
                            ${GuardianLLM.utils.formatDate(data.upload_time || data.timestamp, { 
                                month: 'short', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Processing Time</div>
                        <div class="meta-value" style="font-size: var(--font-size-base);">
                            ${data.processing_time ? `${data.processing_time}s` : 'N/A'}
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Analysis Status</div>
                        <div class="meta-value" style="font-size: var(--font-size-base);">
                            <span class="risk-level-badge ${data.status === 'completed' ? 'low' : 'medium'}">
                                <i class="fas fa-${data.status === 'completed' ? 'check' : 'clock'}"></i>
                                ${data.status || 'Completed'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="overall-score">
                    <div class="score-circle ${overallLevel}">
                        <div class="score-text">${data.overall_risk_score}</div>
                    </div>
                    <div class="score-label">Overall Risk Score</div>
                    <div class="risk-level-badge ${overallLevel}">
                        <i class="fas fa-${getIconForLevel(overallLevel)}"></i>
                        ${overallLevel.toUpperCase()} RISK
                    </div>
                </div>
            `;
        }
        
        // Display analysis summary
        function displayAnalysisSummary(data) {
            const container = document.getElementById('analysisSummary');
            const assessments = data.risk_assessments || [];
            
            // Calculate statistics
            const criticalCount = assessments.filter(a => a.level === 'critical').length;
            const highCount = assessments.filter(a => a.level === 'high').length;
            const totalRecommendations = assessments.reduce((sum, a) => sum + (a.recommendations ? a.recommendations.length : 0), 0);
            const avgConfidence = assessments.length > 0 ? 
                (assessments.reduce((sum, a) => sum + (a.confidence || 0), 0) / assessments.length * 100).toFixed(1) : 0;
            
            // Generate key insights
            const insights = generateKeyInsights(data);
            
            container.innerHTML = `
                <div class="summary-header">
                    <h2 class="summary-title">
                        <i class="fas fa-chart-bar"></i>
                        Analysis Summary
                    </h2>
                    <p style="color: var(--muted-color); font-size: var(--font-size-lg);">
                        Comprehensive ethical risk assessment across ${assessments.length} categories
                    </p>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value">${criticalCount}</div>
                        <div class="stat-label">Critical Risks</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-value">${highCount}</div>
                        <div class="stat-label">High Risks</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="stat-value">${totalRecommendations}</div>
                        <div class="stat-label">Recommendations</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-value">${avgConfidence}%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                </div>
                
                <div class="key-insights">
                    <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); color: var(--dark-color);">
                        <i class="fas fa-key"></i>
                        Key Insights
                    </h3>
                    ${insights.map(insight => `
                        <div class="insight-item">
                            <div class="insight-title">${insight.title}</div>
                            <div class="insight-text">${insight.text}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Display risk categories
        function displayRiskCategories(assessments) {
            const container = document.getElementById('riskCategories');
            
            if (!assessments || assessments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: var(--space-8); color: var(--muted-color);">
                        <i class="fas fa-inbox" style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4); opacity: 0.3;"></i>
                        <h3>No Risk Assessments Available</h3>
                        <p>Unable to load risk assessment data.</p>
                    </div>
                `;
                return;
            }
            
            // Sort assessments by score (highest first)
            const sortedAssessments = [...assessments].sort((a, b) => (b.score || 0) - (a.score || 0));
            
            container.innerHTML = sortedAssessments.map(assessment => `
                <div class="risk-card ${assessment.level}" data-category="${assessment.category}">
                    <div class="risk-header">
                        <div class="risk-category-info">
                            <div class="risk-category-name">
                                <div class="risk-icon ${assessment.level}">
                                    <i class="fas fa-${getIconForCategory(assessment.category)}"></i>
                                </div>
                                ${formatCategoryName(assessment.category)}
                            </div>
                        </div>
                        <div class="risk-score-display">
                            <div class="risk-score-number ${assessment.level}">
                                ${assessment.score}/10
                            </div>
                            <div class="confidence-score">
                                ${Math.round((assessment.confidence || 0) * 100)}% confidence
                            </div>
                        </div>
                    </div>
                    
                    <div class="risk-explanation">
                        ${assessment.explanation || 'No explanation available.'}
                    </div>
                    
                    ${assessment.evidence && assessment.evidence.length > 0 ? `
                        <div class="evidence-section">
                            <div class="section-title">
                                <i class="fas fa-search"></i>
                                Evidence Found
                            </div>
                            <ul class="evidence-list">
                                ${assessment.evidence.slice(0, 5).map(evidence => `
                                    <li class="evidence-item">${GuardianLLM.utils.escapeHtml(evidence)}</li>
                                `).join('')}
                                ${assessment.evidence.length > 5 ? `
                                    <li class="evidence-item" style="font-style: italic;">
                                        +${assessment.evidence.length - 5} more evidence items...
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${assessment.recommendations && assessment.recommendations.length > 0 ? `
                        <div class="recommendations-section">
                            <div class="section-title">
                                <i class="fas fa-lightbulb"></i>
                                Recommendations
                            </div>
                            ${assessment.recommendations.slice(0, 6).map(recommendation => `
                                <div class="recommendation-item">${GuardianLLM.utils.escapeHtml(recommendation)}</div>
                            `).join('')}
                            ${assessment.recommendations.length > 6 ? `
                                <div class="recommendation-item" style="font-style: italic;">
                                    +${assessment.recommendations.length - 6} more recommendations available in detailed report...
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Display analysis timeline
        function displayAnalysisTimeline(timeline) {
            const container = document.getElementById('analysisTimeline');
            const timelineContent = document.getElementById('timelineContent');
            
            if (!timeline || timeline.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            timelineContent.innerHTML = timeline.map(item => `
                <div class="timeline-item">
                    <div class="timeline-time">${GuardianLLM.utils.formatDate(item.timestamp)}</div>
                    <div class="timeline-title">${item.title}</div>
                    <div class="timeline-description">${item.description}</div>
                </div>
            `).join('');
            
            container.style.display = 'block';
        }
        
        // Generate key insights
        function generateKeyInsights(data) {
            const insights = [];
            const assessments = data.risk_assessments || [];
            
            // Highest risk category
            const highestRisk = assessments.reduce((max, current) => 
                (current.score || 0) > (max.score || 0) ? current : max, assessments[0]);
            
            if (highestRisk) {
                insights.push({
                    title: `Primary Concern: ${formatCategoryName(highestRisk.category)}`,
                    text: `This category scored ${highestRisk.score}/10, indicating ${highestRisk.level} risk. Immediate attention recommended for mitigation strategies.`
                });
            }
            
            // Low risk areas
            const lowRisks = assessments.filter(a => a.level === 'low');
            if (lowRisks.length > 0) {
                insights.push({
                    title: `Strong Areas: ${lowRisks.length} Low-Risk Categories`,
                    text: `${lowRisks.map(r => formatCategoryName(r.category)).join(', ')} show minimal ethical concerns, indicating good practices in these areas.`
                });
            }
            
            // Processing efficiency
            if (data.processing_time) {
                const efficiency = data.processing_time < 15 ? 'excellent' : 
                                 data.processing_time < 30 ? 'good' : 'standard';
                insights.push({
                    title: `Analysis Efficiency: ${efficiency.charAt(0).toUpperCase() + efficiency.slice(1)}`,
                    text: `Analysis completed in ${data.processing_time} seconds, demonstrating ${efficiency} system performance and rapid risk assessment capabilities.`
                });
            }
            
            // Overall assessment
            if (data.overall_risk_score < 2.5) {
                insights.push({
                    title: 'Overall Assessment: Low Risk',
                    text: 'This research demonstrates strong ethical considerations with minimal risks identified. Standard review processes are sufficient.'
                });
            } else if (data.overall_risk_score >= 7.5) {
                insights.push({
                    title: 'Overall Assessment: Requires Immediate Attention',
                    text: 'High overall risk score indicates multiple ethical concerns requiring comprehensive review and mitigation before proceeding.'
                });
            }
            
            return insights;
        }
        
        // Utility functions
        function getRiskLevel(score) {
            if (score < 2.5) return 'low';
            if (score < 5.0) return 'medium';
            if (score < 7.5) return 'high';
            return 'critical';
        }
        
        function getIconForLevel(level) {
            const icons = {
                'low': 'check-circle',
                'medium': 'exclamation-circle',
                'high': 'exclamation-triangle',
                'critical': 'times-circle'
            };
            return icons[level] || 'question-circle';
        }
        
        function getIconForCategory(category) {
            const icons = {
                'bias_fairness': 'balance-scale',
                'privacy_data': 'shield-alt',
                'safety_security': 'lock',
                'dual_use': 'exclamation-triangle',
                'societal_impact': 'users',
                'transparency': 'eye'
            };
            return icons[category] || 'question-circle';
        }
        
        function formatCategoryName(category) {
            const names = {
                'bias_fairness': 'Bias & Fairness',
                'privacy_data': 'Privacy & Data',
                'safety_security': 'Safety & Security',
                'dual_use': 'Dual-Use Potential',
                'societal_impact': 'Societal Impact',
                'transparency': 'Transparency'
            };
            return names[category] || category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Export functions
        function exportAnalysis(format) {
            if (!analysisData) {
                showToast('No analysis data available to export', 'error');
                return;
            }
            
            showGlobalLoading(`Generating ${format.toUpperCase()} export...`);
            
            // Simulate export process
            setTimeout(() => {
                hideGlobalLoading();
                
                if (format === 'json') {
                    // Download JSON data
                    const dataStr = JSON.stringify(analysisData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    GuardianLLM.utils.downloadFile(url, `guardian_analysis_${analysisData.paper_id}.json`);
                    showToast('JSON export downloaded successfully', 'success');
                } else {
                    // For other formats, redirect to API endpoint
                    window.open(`/api/paper/${analysisData.paper_id}/export?format=${format}`, '_blank');
                    showToast(`${format.toUpperCase()} export initiated`, 'success');
                }
            }, 1500);
        }
        
        function shareAnalysis() {
            if (!analysisData) {
                showToast('No analysis data available to share', 'error');
                return;
            }
            
            const shareUrl = `${window.location.origin}/analysis/${analysisData.paper_id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Guardian LLM Analysis: ${analysisData.title}`,
                    text: `Ethical risk analysis results for "${analysisData.title}" - Overall score: ${analysisData.overall_risk_score}/10`,
                    url: shareUrl
                }).then(() => {
                    showToast('Analysis shared successfully', 'success');
                }).catch(() => {
                    // Fallback to copy link
                    copyShareLink(shareUrl);
                });
            } else {
                copyShareLink(shareUrl);
            }
        }
        
        function copyShareLink(url) {
            GuardianLLM.utils.copyToClipboard(url);
            showToast('Share link copied to clipboard', 'success');
        }
        
        function analyzeAnotherPaper() {
            if (confirm('Are you sure you want to analyze another paper? This will take you to the main analysis page.')) {
                window.location.href = '/';
            }
        }
        
        // Setup interactions
        function setupAnalysisInteractions() {
            // Add click handlers for risk cards
            document.addEventListener('click', function(e) {
                const riskCard = e.target.closest('.risk-card');
                if (riskCard) {
                    const category = riskCard.dataset.category;
                    if (category) {
                        showCategoryDetails(category);
                    }
                }
            });
            
            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                // Ctrl+S to download report
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    exportAnalysis('pdf');
                }
                
                // Ctrl+Shift+S to share
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
                    e.preventDefault();
                    shareAnalysis();
                }
            });
        }
        
        function showCategoryDetails(category) {
            const assessment = (analysisData.risk_assessments || []).find(a => a.category === category);
            if (!assessment) return;
            
            const categoryName = formatCategoryName(category);
            const evidenceList = assessment.evidence ? 
                assessment.evidence.map(e => `<li>${GuardianLLM.utils.escapeHtml(e)}</li>`).join('') : 
                '<li>No specific evidence found</li>';
            
            const recommendationsList = assessment.recommendations ? 
                assessment.recommendations.map(r => `<li>${GuardianLLM.utils.escapeHtml(r)}</li>`).join('') : 
                '<li>No specific recommendations available</li>';
            
            showModal(`${categoryName} - Detailed Analysis`, `
                <div class="category-details">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4);">
                        <div class="risk-icon ${assessment.level}" style="font-size: var(--font-size-2xl);">
                            <i class="fas fa-${getIconForCategory(category)}"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: var(--dark-color);">${categoryName}</h3>
                            <div style="color: var(--muted-color);">
                                Score: ${assessment.score}/10 | Confidence: ${Math.round((assessment.confidence || 0) * 100)}%
                            </div>
                        </div>
                        <div class="risk-level-badge ${assessment.level}" style="margin-left: auto;">
                            ${assessment.level.toUpperCase()}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="color: var(--dark-color); margin-bottom: var(--space-2);">Analysis</h4>
                        <p style="color: var(--muted-color); line-height: var(--line-height-relaxed);">
                            ${assessment.explanation}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-4);">
                        <h4 style="color: var(--dark-color); margin-bottom: var(--space-2);">Evidence</h4>
                        <ul style="margin: 0; padding-left: var(--space-4); color: var(--muted-color);">
                            ${evidenceList}
                        </ul>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--dark-color); margin-bottom: var(--space-2);">Recommendations</h4>
                        <ul style="margin: 0; padding-left: var(--space-4); color: var(--muted-color);">
                            ${recommendationsList}
                        </ul>
                    </div>
                </div>
            `, { confirmText: 'Close' });
        }
        
        function showError(message) {
            showFlashMessage('error', message);
            
            // Show error state in main content
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="text-align: center; padding: var(--space-16); color: var(--muted-color);">
                    <i class="fas fa-exclamation-triangle" style="font-size: var(--font-size-5xl); margin-bottom: var(--space-4); color: var(--danger-color);"></i>
                    <h2 style="margin-bottom: var(--space-3); color: var(--dark-color);">Analysis Not Available</h2>
                    <p style="margin-bottom: var(--space-6); font-size: var(--font-size-lg);">${message}</p>
                    <div style="display: flex; gap: var(--space-4); justify-content: center;">
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Start New Analysis
                        </a>
                        <a href="/dashboard" class="btn btn-outline">
                            <i class="fas fa-chart-line"></i>
                            View Dashboard
                        </a>
                    </div>
                </div>
            `;
        }
        
        // Initialize tooltips and other interactive elements
        function initializeInteractiveElements() {
            // Add tooltips to risk scores
            document.querySelectorAll('.risk-score-number').forEach(element => {
                const level = element.className.split(' ').find(c => ['low', 'medium', 'high', 'critical'].includes(c));
                const ranges = {
                    'low': '0-2.5',
                    'medium': '2.5-5.0', 
                    'high': '5.0-7.5',
                    'critical': '7.5-10.0'
                };
                element.title = `${level.toUpperCase()} risk (${ranges[level]} range)`;
            });
            
            // Add copy functionality to paper ID
            document.querySelectorAll('[data-paper-id]').forEach(element => {
                element.style.cursor = 'pointer';
                element.title = 'Click to copy Paper ID';
                element.addEventListener('click', function() {
                    GuardianLLM.utils.copyToClipboard(this.dataset.paperId);
                    showToast('Paper ID copied to clipboard', 'success');
                });
            });
        }
        
        // Call initialization after DOM updates
        setTimeout(initializeInteractiveElements, 500);
        
        console.log('✅ Analysis page initialized');
    </script>
{% endblock %}